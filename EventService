using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Data;
using System.Data.SqlClient;
using Sabio.Data;
using Sabio.Web.Models.Requests;
using Sabio.Web.Domain;
using Sabio.Web.Enums;
using System.Globalization;
using Newtonsoft.Json;
using Newtonsoft.Json.Converters;
using Sabio.Web.Services.Interfaces;

namespace Sabio.Web.Services
{
    public class EventService : BaseService, IEventService
    {
        private IMerchantService _merchantService;
        private IOrganizationsService _organizationsService;
        private ILocationService _locationService;
        public EventService(IMerchantService MerchantService, IOrganizationsService organizationsService, ILocationService locationService)
        {           
            _merchantService = MerchantService;
            _organizationsService = organizationsService;
            _locationService = locationService;
        }

        public Guid GetDate(string StartDateTime, string EndDateTime)
        {

            DateTimeOffset StartDate = JsonConvert.DeserializeObject<DateTimeOffset>(StartDateTime, new IsoDateTimeConverter());

            //DateTime StartDate = DateTime.ParseExact(StartDateTime, "o", CultureInfo.InvariantCulture);
            DateTimeOffset EndDate = JsonConvert.DeserializeObject<DateTimeOffset>(EndDateTime, new IsoDateTimeConverter());
            // Try to parse the dates
            
            
                MerchantCalendar model = new MerchantCalendar();
                model.Start = StartDate;
                model.End = EndDate;
                var currentUserId = _merchantService.GetMerchantByUserId(UserService.GetCurrentUserId());
                model.MerchantId = currentUserId.Id;
                Guid newUid = InsertMerchantEvent(model);

                return newUid;          
        }

        public List<Events> GetEventsByCurrentOrg()
        {
            var currentUser = UserService.GetCurrentUserId();
            var org = _organizationsService.GetOrganizationByUserId(currentUser);
            List<Events> results = GetMerchantEventsRequest(org.Id);
            return results;
        }
        
        public Guid InsertMerchantEvent(MerchantCalendar model)
        {
            Guid uid = Guid.Empty;



            DataProvider.ExecuteNonQuery(GetConnection, "dbo.MerchantEvents_Insert"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   SqlParameter p = new SqlParameter("@Uid", System.Data.SqlDbType.UniqueIdentifier);
                   p.Direction = System.Data.ParameterDirection.Output;

                   paramCollection.Add(p);

                   paramCollection.AddWithValue("@MerchantId", model.MerchantId);
                   paramCollection.AddWithValue("@ContactName", "Contact Name");
                   paramCollection.AddWithValue("@EventTitle", "Blackout");
                   paramCollection.AddWithValue("@StartDateTime", model.Start);
                   paramCollection.AddWithValue("@EndDateTime", model.End);
                   paramCollection.AddWithValue("@AllDay", true); 
                   paramCollection.AddWithValue("@ClassName", "Blackout");
                   paramCollection.AddWithValue("@Guests", 0);
               }, returnParameters: delegate(SqlParameterCollection param)
               {
                   Guid.TryParse(param["@Uid"].Value.ToString(), out uid);
               });


            return uid;
        }
        public Guid UpdateMerchantEvent(MerchantCalendar model, Merchant currentUserId)
        {
            Guid uid = Guid.Empty;

            DataProvider.ExecuteNonQuery(GetConnection, "dbo.MerchantEvents_Update"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@Uid", model.Uid);
                   paramCollection.AddWithValue("@MerchantId", currentUserId.Id);
                   paramCollection.AddWithValue("@ContactName", model.ContactName);
                   paramCollection.AddWithValue("@EventTitle", model.Title);
                   paramCollection.AddWithValue("@StartDateTime", model.Start);
                   paramCollection.AddWithValue("@EndDateTime", model.End);
                   paramCollection.AddWithValue("@AllDay", true);
                   paramCollection.AddWithValue("@Location", model.Location);
                   paramCollection.AddWithValue("@Contribution", model.Contribution);
                   paramCollection.AddWithValue("@Confirm", model.Confirm);                  
                   paramCollection.AddWithValue("@ClassName", model.ClassName);
                   paramCollection.AddWithValue("@Guest", model.Guests);

               }, returnParameters: delegate(SqlParameterCollection param)
               {
                   Guid.TryParse(param["@Uid"].Value.ToString(), out uid);
               });


            return uid;
        }
        public Guid UpdateMerchantEventRequest(MerchantCalendar model)
        {
            Guid uid = Guid.Empty;

            DataProvider.ExecuteNonQuery(GetConnection, "dbo.MerchantEvents_UpdateRequest"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@Uid", model.Uid);
                   paramCollection.AddWithValue("@MerchantId", model.MerchantId);
                   paramCollection.AddWithValue("@OrganizationId", model.OrganizationId);
                   paramCollection.AddWithValue("@ContactName", model.ContactName);
                   paramCollection.AddWithValue("@EventTitle", model.Title);
                   paramCollection.AddWithValue("@StartDateTime", model.Start);
                   paramCollection.AddWithValue("@EndDateTime", model.End);
                   paramCollection.AddWithValue("@AllDay", model.AllDay);
                   paramCollection.AddWithValue("@Location", model.Location);
                   paramCollection.AddWithValue("@Contribution", model.Contribution);
                   paramCollection.AddWithValue("@Confirm", model.Confirm);
                   paramCollection.AddWithValue("@ClassName", model.ClassName);
                   paramCollection.AddWithValue("@Guests", model.Guests);

               }, returnParameters: delegate(SqlParameterCollection param)
               {
                   Guid.TryParse(param["@Uid"].Value.ToString(), out uid);
               });


            return uid;
        }
        public List<Events> GetMerchantEvents(int currentId)
        {
            List<Events> events = null;

            DataProvider.ExecuteCmd(GetConnection, "dbo.MerchantEvents_Select"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@MerchantId", currentId);

                   //  this is where your input params go. it works the same way as with ExecuteNonQuery.                                                     
               }        //reader represents the current row that is returned
               , map: delegate(IDataReader reader, short set)
               {
                   Events Items = new Events();
                   int startingIndex = 0; //startingOrdinal
                   //these have to go in the exact order they are in the SELECT stored proc
                   Items.Uid = reader.GetGuid(startingIndex++);
                   Items.MerchantId = reader.GetSafeInt32(startingIndex++);
                   Items.OrganizationId = reader.GetSafeInt32(startingIndex++);
                   Items.ContactName = reader.GetSafeString(startingIndex++);
                   Items.Title = reader.GetSafeString(startingIndex++);
                   Items.Start = reader.GetDateTime(startingIndex++);
                   Items.Start = DateTime.SpecifyKind(Items.Start, DateTimeKind.Utc);   //specify that Start is in UTC
                   Items.End = reader.GetDateTime(startingIndex++);
                   Items.End = DateTime.SpecifyKind(Items.End, DateTimeKind.Utc);     //specify that End is in UTC
                   Items.AllDay = reader.GetBoolean(startingIndex++);
                   Items.Location = reader.GetSafeString(startingIndex++);
                   Items.Contribution = reader.GetSafeString(startingIndex++);
                   Items.Confirm = reader.GetBoolean(startingIndex++);
                   Items.ClassName = reader.GetSafeString(startingIndex++);
                   Items.Guests = reader.GetSafeInt32(startingIndex++);

                   if (events == null)
                   {
                       events = new List<Events>();
                   }

                   events.Add(Items);

               }
               );

            return events;
        }

        public void DeleteMerchantEvents(MerchantCalendar model, int MerchantId)
        {
            DataProvider.ExecuteNonQuery(GetConnection, "dbo.MerchantEvents_Delete"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {
                   paramCollection.AddWithValue("@MerchantId", MerchantId);
                   paramCollection.AddWithValue("@Uid", model.Uid);
                   
                  

               }, returnParameters: delegate(SqlParameterCollection param)
               {
                   
               });
            
        }
        public void ConfirmMerchantEvents(MerchantCalendar model, int MerchantId)
        {
            DataProvider.ExecuteNonQuery(GetConnection, "dbo.MerchantEvents_Confirm"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {
                   paramCollection.AddWithValue("@MerchantId", MerchantId);
                   paramCollection.AddWithValue("@Uid", model.Uid);



               }, returnParameters: delegate(SqlParameterCollection param)
               {

               });
        }

        //check for blackout conflicts
        

        //organization requests individual merchant for an event
        public Guid InsertOrgEvent(MerchantCalendar model)
        {
            Guid uid = Guid.Empty;
            Merchant coordinates = _merchantService.GetMerchantById(model.MerchantId);

            DataProvider.ExecuteNonQuery(GetConnection, "dbo.MerchantEvents_InsertRequest"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {
                   SqlParameter p = new SqlParameter("@Uid", System.Data.SqlDbType.UniqueIdentifier);
                   p.Direction = System.Data.ParameterDirection.Output;

                   paramCollection.Add(p);

                   paramCollection.AddWithValue("@MerchantId", model.MerchantId);
                   paramCollection.AddWithValue("@OrganizationId", model.OrganizationId);
                   paramCollection.AddWithValue("@ContactName", model.ContactName);
                   paramCollection.AddWithValue("@EventTitle", model.Title);
                   paramCollection.AddWithValue("@StartDateTime", model.Start);
                   paramCollection.AddWithValue("@EndDateTime", model.End);
                   paramCollection.AddWithValue("@AllDay", model.AllDay);
                   paramCollection.AddWithValue("@Location", model.Location);
                   paramCollection.AddWithValue("@Contribution", model.Contribution);
                   paramCollection.AddWithValue("@Confirm", model.Confirm);
                   paramCollection.AddWithValue("@ClassName", "Fundraiser");  //Should this be a select option in the form?
                   paramCollection.AddWithValue("@Guests", model.Guests);
                   paramCollection.AddWithValue("@MerchantLatitude", coordinates.Address.Latitude);
                   paramCollection.AddWithValue("@MerchantLongitude", coordinates.Address.Longitude);

               }, returnParameters: delegate(SqlParameterCollection param)
               {
                   Guid.TryParse(param["@Uid"].Value.ToString(), out uid);
               });


            return uid;
        }

        public List<Events> GetMerchantEventsRequest(int orgId)
        {
            List<Events> events = null;

            DataProvider.ExecuteCmd(GetConnection, "dbo.MerchantEvents_SelectByOrgId"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@OrganizationId", orgId);
                   //  this is where your input params go. it works the same way as with ExecuteNonQuery.                                                     
               }        //reader represents the current row that is returned
               , map: delegate(IDataReader reader, short set)
               {
                   Events Items = new Events();
                   int startingIndex = 0; //startingOrdinal
                   //these have to go in the exact order they are in the SELECT stored proc
                   Items.Uid = reader.GetGuid(startingIndex++);
                   Items.MerchantId = reader.GetSafeInt32(startingIndex++);
                   Items.OrganizationId = reader.GetSafeInt32(startingIndex++);
                   Items.Title = reader.GetSafeString(startingIndex++);
                   Items.Start = reader.GetDateTime(startingIndex++);
                   Items.Start = DateTime.SpecifyKind(Items.Start, DateTimeKind.Utc);   //specify that Start is in UTC
                   Items.End = reader.GetDateTime(startingIndex++);
                   Items.End = DateTime.SpecifyKind(Items.End, DateTimeKind.Utc);     //specify that End is in UTC
                   Items.AllDay = reader.GetBoolean(startingIndex++);
                   Items.Location = reader.GetSafeString(startingIndex++);
                   Items.Contribution = reader.GetSafeString(startingIndex++);
                   Items.Confirm = reader.GetBoolean(startingIndex++);
                   Items.ClassName = reader.GetSafeString(startingIndex++);
                   Items.Guests = reader.GetSafeInt32(startingIndex++);



                   if (events == null)
                   {
                       events = new List<Events>();
                   }

                   events.Add(Items);

               }
               );

            return events;
        }

        public bool IsAvailable(MerchantCalendar model)
        {
            List<Events> pendingEvents = GetConflicts(model.MerchantId);
            if (pendingEvents == null || pendingEvents.Count == 0)
                return true;
            foreach (Events item in pendingEvents)
            {
                if (item.Uid != model.Uid)
                {
                    if (model.Start > item.Start && model.Start < item.End)
                        return false;
                    else if (model.End > item.Start && model.End < item.End)
                        return false;
                    else if (model.Start <= item.Start && model.End >= item.End)
                        return false;
                }                
            }
            return true;
        }

        public List<Events> GetConflicts(int newId)
        {
            List<Events> events = null;

            DataProvider.ExecuteCmd(GetConnection, "dbo.MerchantEvents_SelectPossibleConflicts"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@MerchantId", newId);

                   //  this is where your input params go. it works the same way as with ExecuteNonQuery.                                                     
               }        //reader represents the current row that is returned
               , map: delegate(IDataReader reader, short set)
               {
                   Events Items = new Events();
                   int startingIndex = 0; //startingOrdinal
                   //these have to go in the exact order they are in the SELECT stored proc
                   Items.Uid = reader.GetGuid(startingIndex++);
                   Items.MerchantId = reader.GetSafeInt32(startingIndex++);
                   Items.OrganizationId = reader.GetSafeInt32(startingIndex++);
                   Items.Title = reader.GetSafeString(startingIndex++);
                   Items.Start = reader.GetDateTime(startingIndex++);
                   Items.Start = DateTime.SpecifyKind(Items.Start, DateTimeKind.Utc);   //specify that Start is in UTC
                   Items.End = reader.GetDateTime(startingIndex++);
                   Items.End = DateTime.SpecifyKind(Items.End, DateTimeKind.Utc);     //specify that End is in UTC
                   Items.AllDay = reader.GetBoolean(startingIndex++);
                   Items.Location = reader.GetSafeString(startingIndex++);
                   Items.Contribution = reader.GetSafeString(startingIndex++);
                   Items.Confirm = reader.GetBoolean(startingIndex++);
                   Items.ClassName = reader.GetSafeString(startingIndex++);
                   Items.Guests = reader.GetSafeInt32(startingIndex++);


                   if (events == null)
                   {
                       events = new List<Events>();
                   }

                   events.Add(Items);

               }
               );

            return events;
        }

        public Events GetEvent(Guid eventGuid)
        {
            Events result = null;

            DataProvider.ExecuteCmd(GetConnection, "dbo.MerchantEvents_SelectByUid"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@Uid", eventGuid);

                   //  this is where your input params go. it works the same way as with ExecuteNonQuery.                                                     
               }        //reader represents the current row that is returned
               , map: delegate(IDataReader reader, short set)
               {
                   Events Items = new Events();
                   int startingIndex = 0; //startingOrdinal
                   //these have to go in the exact order they are in the SELECT stored proc
                   Items.Uid = reader.GetGuid(startingIndex++);
                   Items.MerchantId = reader.GetSafeInt32(startingIndex++);
                   Items.OrganizationId = reader.GetSafeInt32(startingIndex++);
                   Items.ContactName = reader.GetSafeString(startingIndex++);
                   Items.Title = reader.GetSafeString(startingIndex++);
                   Items.Start = reader.GetDateTime(startingIndex++);
                   Items.Start = DateTime.SpecifyKind(Items.Start, DateTimeKind.Utc);   //specify that Start is in UTC
                   Items.End = reader.GetDateTime(startingIndex++);
                   Items.End = DateTime.SpecifyKind(Items.End, DateTimeKind.Utc);     //specify that End is in UTC
                   Items.AllDay = reader.GetBoolean(startingIndex++);
                   Items.Location = reader.GetSafeString(startingIndex++);
                   Items.Contribution = reader.GetSafeString(startingIndex++);
                   Items.Confirm = reader.GetBoolean(startingIndex++);
                   Items.ClassName = reader.GetSafeString(startingIndex++);
                   Items.Guests = reader.GetSafeInt32(startingIndex++);

                   result = Items;

               }
               );

            return result;
        }
        public Events GetActiveEvent(int merchant)
        {
            var current = DateTime.UtcNow;
            List<Events> allEvents = GetMerchantEvents(merchant);
            if (allEvents!=null && allEvents.Count > 0)
            {
                foreach (Events item in allEvents)
                {
                    var startCompare = current.CompareTo(item.Start);
                    var endCompare = current.CompareTo(item.End);

                    if (current >= item.Start && current <= item.End)
                    {
                        if (item.ClassName == "Fundraiser")
                        {
                            return item;
                        }
                        
                    }
                }
            }            
            return null;
        }
        public List<EventDetails> GetConfirmedMerchantEvents(int merchantId)
        {
            //create 3 separate lists to be combined at the end
            List<EventDetails> events = null;
            List<Merchant> merchants = new List<Merchant>();
            List<Organization> orgs = new List<Organization>();

            DataProvider.ExecuteCmd(GetConnection, "dbo.MerchantEvents_SelectConfirmedByMerId"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@MerchantId", merchantId);

                   //  this is where your input params go. it works the same way as with ExecuteNonQuery.                                                     
               }        //reader represents the current row that is returned
               , map: delegate(IDataReader reader, short set)
               {

                   int startingIndex = 0; //startingOrdinal
                   if (set == 0) //refers to the first table selected in the db
                   {
                       EventDetails currentEvent = new EventDetails();
                       //these have to go in the exact order they are in the SELECT stored proc
                       currentEvent.Uid = reader.GetGuid(startingIndex++);
                       currentEvent.MerchantId = reader.GetSafeInt32(startingIndex++);
                       currentEvent.OrganizationId = reader.GetSafeInt32(startingIndex++);
                       currentEvent.ContactName = reader.GetSafeString(startingIndex++);
                       currentEvent.Title = reader.GetSafeString(startingIndex++);
                       currentEvent.Start = reader.GetDateTime(startingIndex++);
                       currentEvent.Start = DateTime.SpecifyKind(currentEvent.Start, DateTimeKind.Utc);   //specify that Start is in UTC
                       currentEvent.End = reader.GetDateTime(startingIndex++);
                       currentEvent.End = DateTime.SpecifyKind(currentEvent.End, DateTimeKind.Utc);     //specify that End is in UTC
                       currentEvent.AllDay = reader.GetBoolean(startingIndex++);
                       currentEvent.Location = reader.GetSafeString(startingIndex++);
                       currentEvent.Contribution = reader.GetSafeString(startingIndex++);
                       currentEvent.Confirm = reader.GetBoolean(startingIndex++);
                       currentEvent.ClassName = reader.GetSafeString(startingIndex++);
                       currentEvent.Guests = reader.GetSafeInt32(startingIndex++);

                       if (events == null)
                       {
                           events = new List<EventDetails>();
                       }
                       events.Add(currentEvent);
                   }

                   else if (set == 1)
                   {  //mapping merchant data
                       Merchant merchant = new Merchant();
                       merchant.Id = reader.GetSafeInt32(startingIndex++);
                       merchant.Uid = reader.GetGuid(startingIndex++);
                       merchant.Name = reader.GetSafeString(startingIndex++);
                       merchant.Phone = reader.GetSafeString(startingIndex++);

                       merchant.Address = new Address();
                       merchant.Address.Id = reader.GetSafeInt32(startingIndex++);
                       if (merchant.Address.Id > 0)
                       {
                           merchant.Address.Address1 = reader.GetSafeString(startingIndex++);
                           merchant.Address.Address2 = reader.GetSafeString(startingIndex++);
                           merchant.Address.City = reader.GetSafeString(startingIndex++);
                           merchant.Address.State = reader.GetSafeString(startingIndex++);
                           merchant.Address.Zip = reader.GetSafeString(startingIndex++);
                           merchant.Address.Country = reader.GetSafeString(startingIndex++);
                           merchant.Address.Latitude = reader.GetSafeDecimal(startingIndex++);
                           merchant.Address.Longitude = reader.GetSafeDecimal(startingIndex++);
                       }
                   }

                   else if (set == 2)
                   {  //mapping organization data
                       Organization org = new Organization();
                       org.Id = reader.GetSafeInt32(startingIndex++);
                       org.Uid = reader.GetGuid(startingIndex++);
                       org.Name = reader.GetSafeString(startingIndex++);
                       org.ContactName = reader.GetSafeString(startingIndex++);
                       org.Phone = reader.GetSafeString(startingIndex++);
                       org.Address = new Address();
                       org.Address.Id = reader.GetSafeInt32(startingIndex++);

                       if (org.Address.Id > 0)
                       {
                           org.Address.Address1 = reader.GetSafeString(startingIndex++);
                           org.Address.Address2 = reader.GetSafeString(startingIndex++);
                           org.Address.City = reader.GetSafeString(startingIndex++);
                           org.Address.State = reader.GetSafeString(startingIndex++);
                           org.Address.Zip = reader.GetSafeString(startingIndex++);
                           org.Address.Country = reader.GetSafeString(startingIndex++);
                           org.Address.Latitude = reader.GetSafeDecimal(startingIndex++);
                           org.Address.Longitude = reader.GetSafeDecimal(startingIndex++);
                       }
                       else
                       {
                           org.Address = null;
                       }

                       orgs.Add(org);
                   }
               }
               );

            if (events == null)
            {
                return events;
            }
            else
            {//looping through the event pulled and finding matching merchant and org, then attaching them
                foreach (EventDetails eventDetail in events)
                {
                    foreach (Merchant merchant in merchants)
                    {
                        if (eventDetail.MerchantId == merchant.Id)
                        {
                            eventDetail.Merchant = merchant;
                        }
                    }
                    foreach (Organization org in orgs)
                    {
                        if (eventDetail.OrganizationId == org.Id)
                        {
                            eventDetail.Organization = org;
                        }
                    }
                }
                return events;
            }
        }

        public List<EventDetails> GetConfirmedEventsByOrgId(int orgId)
        {
            List<EventDetails> events = null;
            List<Organization> orgs = new List<Organization>();
            List<Merchant> merchants = new List<Merchant>();


            DataProvider.ExecuteCmd(GetConnection, "dbo.MerchantEvents_SelectConfirmedByOrgId"
               , inputParamMapper: delegate(SqlParameterCollection paramCollection)
               {

                   paramCollection.AddWithValue("@OrganizationId", orgId);

                   //  this is where your input params go. it works the same way as with ExecuteNonQuery.                                                     
               }        //reader represents the current row that is returned
               , map: delegate(IDataReader reader, short set)
               {
                   int startingIndex = 0; //startingOrdinal
                   if (set == 0) //refers to the first table selected in the db
                   {
                       EventDetails currentEvent = new EventDetails();
                       //these have to go in the exact order they are in the SELECT stored proc
                       currentEvent.Uid = reader.GetGuid(startingIndex++);
                       currentEvent.MerchantId = reader.GetSafeInt32(startingIndex++);
                       currentEvent.OrganizationId = reader.GetSafeInt32(startingIndex++);
                       currentEvent.ContactName = reader.GetSafeString(startingIndex++);
                       currentEvent.Title = reader.GetSafeString(startingIndex++);
                       currentEvent.Start = reader.GetDateTime(startingIndex++);
                       currentEvent.Start = DateTime.SpecifyKind(currentEvent.Start, DateTimeKind.Utc);   //specify that Start is in UTC
                       currentEvent.End = reader.GetDateTime(startingIndex++);
                       currentEvent.End = DateTime.SpecifyKind(currentEvent.End, DateTimeKind.Utc);     //specify that End is in UTC
                       currentEvent.AllDay = reader.GetBoolean(startingIndex++);
                       currentEvent.Location = reader.GetSafeString(startingIndex++);
                       currentEvent.Contribution = reader.GetSafeString(startingIndex++);
                       currentEvent.Confirm = reader.GetBoolean(startingIndex++);
                       currentEvent.ClassName = reader.GetSafeString(startingIndex++);
                       currentEvent.Guests = reader.GetSafeInt32(startingIndex++);

                       if (events == null)
                       {
                           events = new List<EventDetails>();
                       }
                       events.Add(currentEvent);
                   }

                   else if (set == 1)
                   {  //mapping organization data
                       Organization org = new Organization();
                       org.Id = reader.GetSafeInt32(startingIndex++);
                       org.Uid = reader.GetGuid(startingIndex++);
                       org.Name = reader.GetSafeString(startingIndex++);
                       org.ContactName = reader.GetSafeString(startingIndex++);
                       org.Phone = reader.GetSafeString(startingIndex++);
                       org.Address = new Address();
                       org.Address.Id = reader.GetSafeInt32(startingIndex++);

                       if (org.Address.Id > 0)
                       {
                           org.Address.Address1 = reader.GetSafeString(startingIndex++);
                           org.Address.Address2 = reader.GetSafeString(startingIndex++);
                           org.Address.City = reader.GetSafeString(startingIndex++);
                           org.Address.State = reader.GetSafeString(startingIndex++);
                           org.Address.Zip = reader.GetSafeString(startingIndex++);
                           org.Address.Country = reader.GetSafeString(startingIndex++);
                           org.Address.Latitude = reader.GetSafeDecimal(startingIndex++);
                           org.Address.Longitude = reader.GetSafeDecimal(startingIndex++);
                       }
                       else
                       {
                           org.Address = null;
                       }

                       orgs.Add(org);
                   }

                   else if (set == 2)
                   {   //mapping merchant data
                       Merchant merchant = new Merchant();
                       merchant.Id = reader.GetSafeInt32(startingIndex++);
                       merchant.Uid = reader.GetGuid(startingIndex++);
                       merchant.Name = reader.GetSafeString(startingIndex++);
                       merchant.Phone = reader.GetSafeString(startingIndex++);

                       merchant.Address = new Address();
                       merchant.Address.Id = reader.GetSafeInt32(startingIndex++);
                       if (merchant.Address.Id > 0)
                       {
                           merchant.Address.Address1 = reader.GetSafeString(startingIndex++);
                           merchant.Address.Address2 = reader.GetSafeString(startingIndex++);
                           merchant.Address.City = reader.GetSafeString(startingIndex++);
                           merchant.Address.State = reader.GetSafeString(startingIndex++);
                           merchant.Address.Zip = reader.GetSafeString(startingIndex++);
                           merchant.Address.Country = reader.GetSafeString(startingIndex++);
                           merchant.Address.Latitude = reader.GetSafeDecimal(startingIndex++);
                           merchant.Address.Longitude = reader.GetSafeDecimal(startingIndex++);
                       }
                       else
                       {
                           merchant.Address = null;
                       }

                   }
               }
               );
            if (events == null)
            {
                return events;
            }
            else
            {  //looping through the event pulled and finding matching merchant and org, then attaching them
                foreach (EventDetails eventDetail in events)
                {
                    foreach (Organization org in orgs)
                    {
                        if (eventDetail.OrganizationId == org.Id)
                        {
                            eventDetail.Organization = org;
                        }
                    }
                    foreach (Merchant merchant in merchants)
                    {
                        if (eventDetail.MerchantId == merchant.Id)
                        {
                            eventDetail.Merchant = merchant;
                        }
                    }
                }
                return events;
            }
           
        }

    

        public List<EventDetails> ListLocalEvents(Location location)
        {
            List<EventDetails> events = null;
            List<Organization> orgs = new List<Organization>();
            List<Merchant> merchants = new List<Merchant>();                      

                DataProvider.ExecuteCmd(GetConnection, "dbo.MerchantEvents_SelectLocalEvents"
                   , inputParamMapper: delegate(SqlParameterCollection paramCollection)
                   {

                       paramCollection.AddWithValue("@lat", location.Latitude);
                       paramCollection.AddWithValue("@lng", location.Longitude);
                     //  paramCollection.AddWithValue("@distance", "25");  Distance is designated in stored proc

                       //  this is where your input params go. it works the same way as with ExecuteNonQuery.                                                     
                   }        //reader represents the current row that is returned
                   , map: delegate(IDataReader reader, short set)
                   {

                       int startingIndex = 0; //startingOrdinal
                       if (set == 0) //refers to the first table selected in the db
                       {
                           EventDetails currentEvent = new EventDetails();
                           //these have to go in the exact order they are in the SELECT stored proc
                           currentEvent.Uid = reader.GetGuid(startingIndex++);
                           currentEvent.MerchantId = reader.GetSafeInt32(startingIndex++);
                           currentEvent.OrganizationId = reader.GetSafeInt32(startingIndex++);
                           currentEvent.ContactName = reader.GetSafeString(startingIndex++);
                           currentEvent.Title = reader.GetSafeString(startingIndex++);
                           currentEvent.Start = reader.GetDateTime(startingIndex++);
                           currentEvent.Start = DateTime.SpecifyKind(currentEvent.Start, DateTimeKind.Utc);   //specify that Start is in UTC
                           currentEvent.End = reader.GetDateTime(startingIndex++);
                           currentEvent.End = DateTime.SpecifyKind(currentEvent.End, DateTimeKind.Utc);     //specify that End is in UTC
                           currentEvent.AllDay = reader.GetBoolean(startingIndex++);
                           currentEvent.Location = reader.GetSafeString(startingIndex++);
                           currentEvent.Contribution = reader.GetSafeString(startingIndex++);
                           currentEvent.Confirm = reader.GetBoolean(startingIndex++);
                           currentEvent.ClassName = reader.GetSafeString(startingIndex++);
                           currentEvent.Guests = reader.GetSafeInt32(startingIndex++);
                           currentEvent.MerchantLatitude = reader.GetSafeDecimal(startingIndex++);
                           currentEvent.MerchantLongitude = reader.GetSafeDecimal(startingIndex++);
                           currentEvent.MerchantDistance = reader.GetSafeDouble(startingIndex++);
                           if (events == null)
                           {
                               events = new List<EventDetails>();
                           }
                           events.Add(currentEvent);
                       }

                       else if (set == 1)
                       {  //mapping merchant data
                           Merchant merchant = new Merchant();
                           merchant.Id = reader.GetSafeInt32(startingIndex++);
                           merchant.Uid = reader.GetGuid(startingIndex++);
                           merchant.Name = reader.GetSafeString(startingIndex++);
                           merchant.Phone = reader.GetSafeString(startingIndex++);

                           merchant.Address = new Address();
                           merchant.Address.Id = reader.GetSafeInt32(startingIndex++);
                           if (merchant.Address.Id > 0)
                           {
                               merchant.Address.Address1 = reader.GetSafeString(startingIndex++);
                               merchant.Address.Address2 = reader.GetSafeString(startingIndex++);
                               merchant.Address.City = reader.GetSafeString(startingIndex++);
                               merchant.Address.State = reader.GetSafeString(startingIndex++);
                               merchant.Address.Zip = reader.GetSafeString(startingIndex++);
                               merchant.Address.Country = reader.GetSafeString(startingIndex++);
                               
                           }
                       }

                       else if (set == 2)
                       {  //mapping organization data
                           Organization org = new Organization();
                           org.Id = reader.GetSafeInt32(startingIndex++);
                           org.Uid = reader.GetGuid(startingIndex++);
                           org.Name = reader.GetSafeString(startingIndex++);
                           org.ContactName = reader.GetSafeString(startingIndex++);
                           org.Phone = reader.GetSafeString(startingIndex++);
                           org.Address = new Address();
                           org.Address.Id = reader.GetSafeInt32(startingIndex++);

                           if (org.Address.Id > 0)
                           {
                               org.Address.Address1 = reader.GetSafeString(startingIndex++);
                               org.Address.Address2 = reader.GetSafeString(startingIndex++);
                               org.Address.City = reader.GetSafeString(startingIndex++);
                               org.Address.State = reader.GetSafeString(startingIndex++);
                               org.Address.Zip = reader.GetSafeString(startingIndex++);
                               org.Address.Country = reader.GetSafeString(startingIndex++);
                               org.Address.Latitude = reader.GetSafeDecimal(startingIndex++);
                               org.Address.Longitude = reader.GetSafeDecimal(startingIndex++);
                           }
                           else
                           {
                               org.Address = null;
                           }

                           orgs.Add(org);
                       }
                   }
                   );
                if (events == null)
                {
                    return events;
                }
                else
                {
                    //looping through the event pulled and finding matching merchant and org, then attaching them
                    foreach (EventDetails eventDetail in events)
                    {
                        foreach (Merchant merchant in merchants)
                        {
                            if (eventDetail.MerchantId == merchant.Id)
                            {
                                eventDetail.Merchant = merchant;
                            }
                        }
                        foreach (Organization org in orgs)
                        {
                            if (eventDetail.OrganizationId == org.Id)
                            {
                                eventDetail.Organization = org;
                            }
                        }
                    }
                    return events;
                }
            }
        }
    }
